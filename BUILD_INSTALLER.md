# Building the AMICUS Installer

This guide explains how to create a new installer for AMICUS after making code changes.

## Prerequisites

- **Inno Setup 6.3.3+** must be installed
  - Download from: https://jrsoftware.org/isdl.php
  - Install with default settings
  - Compiler location: `C:\Program Files (x86)\Inno Setup 6\ISCC.exe`

## Step-by-Step Build Process

### 1. Update Version Number

Before creating a new release, update the version in `installer.iss`:

```iss
#define MyAppVersion "1.0.0"  // Change this to your new version (e.g., "1.1.0")
```

**Location:** Line 5 in `installer.iss`

### 2. Clean Previous Build (Optional)

Remove old publish output to ensure a clean build:

```bash
rm -rf bin/Release/net9.0-windows/win-x64/publish/
rm -rf installer_output/
```

### 3. Publish the Application

Run the following command from the project root:

```bash
dotnet publish -c Release -r win-x64 --self-contained true -p:PublishSingleFile=false -p:PublishReadyToRun=false
```

**What this does:**
- Compiles in Release mode (optimized)
- Targets 64-bit Windows (`win-x64`)
- Includes .NET 9.0 runtime (self-contained)
- Output: `bin\Release\net9.0-windows\win-x64\publish\`

**Expected output size:** ~80-100 MB (includes .NET runtime)

### 4. Verify Published Files

Check that the publish was successful:

```bash
ls bin/Release/net9.0-windows/win-x64/publish/
```

You should see:
- `AMICUS.exe` (main executable)
- `Resources/` folder (sprites, icons, etc.)
- Many .dll files (runtime and dependencies)

### 5. Compile the Installer

**Option A: Using Inno Setup IDE (Recommended for first-time)**

1. Open Inno Setup Compiler
2. File → Open → Select `installer.iss`
3. Build → Compile (or press F9)
4. Watch for errors in the compiler output
5. If successful, you'll see: "Successful compile"

**Option B: Using Command Line (Faster)**

```bash
"C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss
```

Or if Inno Setup is in your PATH:

```bash
iscc installer.iss
```

### 6. Locate the Installer

The compiled installer will be at:

```
installer_output\Setup_AMICUS_v{version}.exe
```

Example: `installer_output\Setup_AMICUS_v1.0.0.exe`

## Testing the Installer

### Before Distribution

Always test the installer on a clean system or VM:

1. **Install Test:**
   - Run the installer
   - Choose different installation locations
   - Verify desktop shortcut is created (if selected)
   - Check Start Menu shortcut exists

2. **Startup Test:**
   - Restart Windows
   - Verify AMICUS starts automatically (if startup option was selected)
   - Check: `Win+R` → `shell:startup` for the shortcut

3. **Application Test:**
   - Launch AMICUS from desktop shortcut
   - Verify all features work correctly
   - Check that save data works (`%AppData%\Amicus\save.json`)
   - Test drag, feeding, cleaning, etc.

4. **Uninstall Test:**
   - Open Settings → Apps → AMICUS
   - Uninstall the application
   - Verify files are removed from install location
   - Check that startup entry is removed
   - Save data should be cleaned up

### Test Checklist

- [ ] Installer runs without errors
- [ ] Desktop shortcut created (if selected)
- [ ] Start Menu shortcut created
- [ ] App launches correctly
- [ ] All sprites and resources load
- [ ] Save/load functionality works
- [ ] Startup registration works (if selected)
- [ ] Uninstaller removes all files
- [ ] No errors in Event Viewer

## Installer Configuration Reference

### Files Modified During Build

1. **installer.iss** - Main installer script
   - Update `MyAppVersion` for each release
   - Update `MyAppURL` if repo changes
   - Modify install options if needed

2. **bin/Release/.../publish/** - Auto-generated by dotnet publish
   - Don't modify these files manually
   - Always regenerate with `dotnet publish`

### Installer Features

The installer automatically:
- ✅ Bundles .NET 9.0 runtime (no separate install needed)
- ✅ Allows user to choose install location
- ✅ Creates desktop shortcut (optional)
- ✅ Registers for Windows startup (optional)
- ✅ Creates Start Menu shortcut (always)
- ✅ Includes uninstaller
- ✅ Uses app icon for all shortcuts

### Default Settings

- **Default Install Location:** `C:\Program Files\AMICUS`
- **Privileges Required:** User level (no admin needed)
- **Architecture:** 64-bit Windows only (x64compatible)
- **Minimum Windows Version:** Windows 10

## Troubleshooting

### Common Issues

**Problem:** "Cannot find source file"
- **Solution:** Run `dotnet publish` first to generate files

**Problem:** Version number not updating in installer name
- **Solution:** Update `#define MyAppVersion` in `installer.iss` line 5

**Problem:** Icon not showing in installer
- **Solution:** Verify `Resources\Icon\Icon1.ico` exists

**Problem:** Installer shows deprecation warning
- **Solution:** Ensure `ArchitecturesInstallIn64BitMode=x64compatible` (not `x64`)

**Problem:** App crashes after installation
- **Solution:**
  - Check that Resources folder was included in publish
  - Verify self-contained publish (includes runtime DLLs)
  - Test publish output directly before making installer

### Getting Help

- Inno Setup Documentation: https://jrsoftware.org/ishelp/
- .NET Publish Docs: https://learn.microsoft.com/en-us/dotnet/core/deploying/

## Distribution

### Sharing the Installer

Once tested, you can distribute `Setup_AMICUS_v{version}.exe`:

1. Upload to GitHub Releases
2. Share direct download link
3. Host on your website
4. Share via cloud storage

### File Size

- **Installer Size:** ~80-100 MB
  - Includes full .NET 9.0 runtime
  - All app resources and sprites
  - Compressed with LZMA2

### User Requirements

Users need:
- Windows 10 or Windows 11
- 64-bit system
- ~150 MB free disk space
- No other prerequisites needed

## Quick Reference

```bash
# Complete rebuild process (one command)
rm -rf bin/Release/net9.0-windows/win-x64/publish/ && \
dotnet publish -c Release -r win-x64 --self-contained true && \
iscc installer.iss

# The installer will be at:
# installer_output\Setup_AMICUS_v{version}.exe
```

## Version History

Track your releases here:

- **v1.0.0** - Initial release with installer (2025-01-19)
  - Self-contained .NET 9.0 application
  - Desktop shortcut and startup options
  - Inno Setup based installer

---

**Last Updated:** 2025-01-19
**Installer Type:** Inno Setup 6.3.3+
**Target Platform:** Windows 10/11 (64-bit)
